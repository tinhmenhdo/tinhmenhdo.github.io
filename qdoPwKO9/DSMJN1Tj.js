import{K as t}from"./BhIIwS8l.js";import"./CVVDEXDJ.js";class DrawingBoard{static instance=null;stage;layer;currentShape=null;isDrawing=!1;mode="rect";startPos={x:0,y:0};isProcessingImage=!1;lastProcessedImage=null;isPanning=!1;lastCenter=null;history=[];MAX_HISTORY=50;points=[];textNode=null;isScaling=!1;scaleNode=null;lastMouseX=0;background;constructor(){this.initializeStage(),this.initializeEvents()}static getInstance(){return DrawingBoard.instance||(DrawingBoard.instance=new DrawingBoard),DrawingBoard.instance}getStage(){return this.stage}initializeStage(){const e=document.getElementById("drawing-container");e&&(this.stage=new t.Stage({container:"drawing-container",width:e.clientWidth,height:e.clientHeight,fill:"white"}),this.layer=new t.Layer,this.stage.add(this.layer))}initializeEvents(){this.stage.on("contextmenu",(e=>{e.evt.preventDefault();const n=e.target,s=this.stage.container().getBoundingClientRect(),i=e.evt.clientX-s.left,a=e.evt.clientY-s.top;if(["shape-context-menu"].forEach((t=>{const e=document.getElementById(t);e&&(e.classList.add("hidden"),e.selectedNode=null)})),n instanceof t.Node&&!(n instanceof t.Stage)&&!(n instanceof t.Layer)){const t=document.getElementById("shape-context-menu");if(t){t.style.left=`${i}px`,t.style.top=`${a}px`,t.classList.remove("hidden"),t.selectedNode=n;const e=t.querySelector(".drag-text");e&&(e.textContent=n.draggable()?"Khóa di chuyển":"Mở khóa di chuyển"),t.querySelectorAll('input[type="range"]').forEach((t=>{t.value="100";const e=t.nextElementSibling;e&&(e.textContent="100%")}))}}})),this.stage.on("mousedown touchstart",(e=>{const n=e.target;if(n instanceof t.Node&&!(n instanceof t.Stage)&&!(n instanceof t.Layer)&&n.draggable())return;if(this.isScaling)return void(e.target===this.scaleNode&&(this.lastMouseX=e.evt.clientX));if(2===e.evt.button)return this.isPanning=!0,this.lastCenter=this.stage.getPointerPosition(),void(document.body.style.cursor="grabbing");if(!(e.target instanceof t.Stage||e.target instanceof t.Layer))return;this.isDrawing=!0;const s=this.stage.getPointerPosition(),i=this.stage.scaleX(),a=this.stage.position(),o={x:(s.x-a.x)/i,y:(s.y-a.y)/i};switch(this.startPos=o,this.mode){case"pencil":this.points=[o.x,o.y],this.currentShape=new t.Line({points:this.points,stroke:"black",strokeWidth:2,lineCap:"round",lineJoin:"round",draggable:!0});break;case"rect":this.currentShape=new t.Rect({x:o.x,y:o.y,width:0,height:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"circle":this.currentShape=new t.Circle({x:o.x,y:o.y,radius:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"line":this.currentShape=new t.Line({points:[o.x,o.y,o.x,o.y],stroke:"black",strokeWidth:2,draggable:!0});break;case"text":{const e=document.querySelector('textarea[data-type="drawing-text"]');e&&e.dispatchEvent(new Event("blur"));const n=this.stage.getPointerPosition(),s=this.stage.scaleX(),i=this.stage.position(),a={x:(n.x-i.x)/s,y:(n.y-i.y)/s},o=new t.Text({x:a.x,y:a.y,text:"",fontSize:16,fill:"black",draggable:!0,width:200,cursor:"move"});this.layer.add(o),this.textNode=o;const r=document.createElement("textarea");r.setAttribute("data-type","drawing-text"),document.body.appendChild(r);const c=this.stage.container().getBoundingClientRect(),d={x:n.x+c.left,y:n.y+c.top};Object.assign(r.style,{position:"fixed",top:`${d.y}px`,left:`${d.x}px`,width:"200px",minHeight:"50px",padding:"5px",fontSize:"16px",border:"2px solid #4299e1",borderRadius:"4px",background:"white",outline:"none",resize:"none",overflow:"hidden",zIndex:"10000",margin:"0",lineHeight:"1.2",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",display:"block"}),setTimeout((()=>{r.focus()}),0),r.addEventListener("input",(()=>{r.style.height="auto",r.style.height=`${r.scrollHeight}px`,this.textNode&&(this.textNode.text(r.value),this.layer.batchDraw())}));const l=()=>{r.remove(),this.textNode&&(""===this.textNode.text().trim()?this.textNode.destroy():(this.history.push({node:this.textNode.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.textNode=null,this.layer.batchDraw())};r.addEventListener("blur",l),r.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||r.blur()}));break}}this.currentShape&&this.layer.add(this.currentShape)})),this.stage.on("mousemove touchmove",(t=>{if(this.isScaling&&this.scaleNode&&0!==this.lastMouseX){t.evt.preventDefault();const e=t.evt.clientX-this.lastMouseX>0?1.1:.9,n=this.scaleNode.scaleX()*e;return n>=.1&&n<=50&&(this.scaleNode.scale({x:n,y:n}),this.layer.batchDraw()),void(this.lastMouseX=t.evt.clientX)}if(this.isPanning&&this.lastCenter){t.evt.preventDefault();const e=this.stage.getPointerPosition(),n=e.x-this.lastCenter.x,s=e.y-this.lastCenter.y;return this.stage.position({x:this.stage.x()+n,y:this.stage.y()+s}),this.stage.batchDraw(),void(this.lastCenter=e)}if(!this.isDrawing)return;const e=this.stage.getPointerPosition(),n=this.stage.scaleX(),s=this.stage.position(),i={x:(e.x-s.x)/n,y:(e.y-s.y)/n};switch(this.mode){case"pencil":this.points=this.points.concat([i.x,i.y]),this.currentShape.points(this.points);break;case"rect":{const t=this.currentShape,e=i.x-this.startPos.x,n=i.y-this.startPos.y;e<0?(t.x(i.x),t.width(Math.abs(e))):(t.x(this.startPos.x),t.width(e)),n<0?(t.y(i.y),t.height(Math.abs(n))):(t.y(this.startPos.y),t.height(n));break}case"circle":{const t=this.currentShape,e=Math.sqrt(Math.pow(i.x-this.startPos.x,2)+Math.pow(i.y-this.startPos.y,2));t.radius(e);break}case"line":this.currentShape.points([this.startPos.x,this.startPos.y,i.x,i.y])}this.layer.batchDraw()})),this.stage.on("mouseup touchend",(()=>{this.currentShape&&(this.history.push({node:this.currentShape.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null})),this.stage.on("mouseleave",(()=>{this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null})),this.layer.on("mouseover",(e=>{const n=e.target;!(n instanceof t.Node)||n instanceof t.Stage||n instanceof t.Layer||(n.draggable()&&(document.body.style.cursor="move"),n.getAttr("isScaling")&&(document.body.style.cursor="ew-resize"))})),this.layer.on("mouseout",(()=>{document.body.style.cursor="default"})),this.stage.on("wheel",(t=>{t.evt.preventDefault();const e=this.stage.scaleX(),n=this.stage.getPointerPosition(),s=(n.x-this.stage.x())/e,i=(n.y-this.stage.y())/e,a=(t.evt.deltaY>0?-1:1)>0?1.1*e:e/1.1;if(a<.1||a>10)return;this.stage.scale({x:a,y:a});const o={x:n.x-s*a,y:n.y-i*a};this.stage.position(o),this.stage.batchDraw();const r=document.getElementById("zoom-slider"),c=document.getElementById("zoom-level");if(r&&c){const t=Math.round(100*a);r.value=t.toString(),c.textContent=`${t}%`}}))}setMode(t){this.mode=t}undo(){if(this.history.length>0){const t=this.history[this.history.length-1];switch(t.type){case"delete":this.layer.add(t.node.clone());break;case"dragToggle":const e=this.layer.findOne((e=>e.id()===t.node.id()));e&&e.draggable(!e.draggable());break;default:const n=this.layer.children[this.layer.children.length-1];n&&n.destroy()}this.history.pop(),this.layer.batchDraw()}}async loadImage(e){return new Promise(((n,s)=>{const i=new FileReader;i.onload=()=>{const e=new Image;e.onload=()=>{const s=e.width,i=e.height,a=(this.stage.width()-s)/2,o=(this.stage.height()-i)/2,r=new t.Image({x:a,y:o,image:e,width:s,height:i,draggable:!0,cursor:"move"});this.layer.add(r),this.history.push({node:r.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift(),this.layer.batchDraw(),n()},e.onerror=s,e.src=i.result},i.onerror=s,i.readAsDataURL(e)}))}saveToImage(){const e=this.layer.children;if(0===e.length)return;const n=this.stage.width(),s=this.stage.height(),i=this.stage.scale(),a=this.stage.position();this.stage.scale({x:1,y:1}),this.stage.batchDraw();let o=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,d=Number.NEGATIVE_INFINITY;e.forEach((t=>{const e=t.getClientRect();o=Math.min(o,e.x),r=Math.min(r,e.y),c=Math.max(c,e.x+e.width),d=Math.max(d,e.y+e.height)}));const l=100;o-=l,r-=l,c+=l,d+=l;const h=Math.ceil(c-o),g=Math.ceil(d-r),u=e.map((t=>({node:t,x:t.x(),y:t.y()})));e.forEach((t=>{t.x(t.x()-o),t.y(t.y()-r)})),this.stage.width(h),this.stage.height(g);const m=new t.Rect({x:0,y:0,width:h,height:g,fill:"white"});return this.layer.add(m),m.moveToBottom(),this.layer.batchDraw(),new Promise((t=>{setTimeout((()=>{this.layer.batchDraw();const e=this.stage.toDataURL({pixelRatio:1,quality:1,mimeType:"image/png"});u.forEach((({node:t,x:e,y:n})=>{t.x(e),t.y(n)})),this.stage.width(n),this.stage.height(s),this.stage.scale(i),this.stage.position(a),m.destroy(),this.layer.batchDraw(),t(e)}),100)}))}}const e=DrawingBoard.getInstance(),n=document.getElementById("menu-btn"),s=document.getElementById("close-toolbar"),i=document.getElementById("toolbar");let a=!1;const closeToolbar=()=>{a=!1,i?.classList.remove("open")};n?.addEventListener("click",(t=>{t.stopPropagation(),a?closeToolbar():(a=!0,i?.classList.add("open"))})),s?.addEventListener("click",(()=>{closeToolbar()})),document.addEventListener("click",(t=>{const e=t.target;!a||i?.contains(e)||e===n||e.closest(".tool-btn")||closeToolbar()})),i?.addEventListener("click",(t=>{t.stopPropagation()})),document.getElementById("rect-btn")?.addEventListener("click",(()=>e.setMode("rect"))),document.getElementById("circle-btn")?.addEventListener("click",(()=>e.setMode("circle"))),document.getElementById("line-btn")?.addEventListener("click",(()=>e.setMode("line"))),document.getElementById("pencil-btn")?.addEventListener("click",(()=>e.setMode("pencil"))),document.getElementById("text-btn")?.addEventListener("click",(()=>e.setMode("text"))),document.getElementById("undo-btn")?.addEventListener("click",(()=>e.undo())),document.getElementById("zoom-in-btn")?.addEventListener("click",(()=>{const t=document.getElementById("zoom-slider"),e=parseInt(t.value),n=Math.min(e+10,400);t.value=n.toString(),updateZoom(n)})),document.getElementById("zoom-out-btn")?.addEventListener("click",(()=>{const t=document.getElementById("zoom-slider"),e=parseInt(t.value),n=Math.max(e-10,10);t.value=n.toString(),updateZoom(n)}));const o=document.getElementById("fullscreen-btn"),r=document.getElementById("watermark"),c=document.querySelector("header");o?.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen().then((()=>{if(r?.classList.add("hidden"),c?.classList.remove("hidden"),o){const t=o.querySelector("svg");if(t&&(t.innerHTML='\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />\n            '),o.textContent){const t=o.lastChild;t&&(t.textContent="Toàn màn hình")}}})):document.documentElement.requestFullscreen().then((()=>{if(r?.classList.remove("hidden"),c?.classList.add("hidden"),o){const t=o.querySelector("svg");if(t&&(t.innerHTML='\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" />\n            '),o.textContent){const t=o.lastChild;t&&(t.textContent="Thoát toàn màn hình")}}}))})),document.addEventListener("fullscreenchange",(()=>{if(!document.fullscreenElement&&(r?.classList.add("hidden"),c?.classList.remove("hidden"),o)){const t=o.querySelector("svg");if(t&&(t.innerHTML='\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />\n          '),o.textContent){const t=o.lastChild;t&&(t.textContent="Toàn màn hình")}}}));const d=document.getElementById("zoom-slider"),h=document.getElementById("zoom-level"),updateZoom=t=>{const n=e.getStage();if(!n)return;const s=t/100,i=n.scaleX(),a=n.width()/2,o=n.height()/2,r=(a-n.x())/i,c=(o-n.y())/i;n.scale({x:s,y:s});const d={x:a-r*s,y:o-c*s};n.position(d),n.batchDraw(),h&&(h.textContent=`${Math.round(t)}%`)};d?.addEventListener("input",(t=>{const e=parseInt(t.target.value);updateZoom(e)})),document.getElementById("zoom-in-control")?.addEventListener("click",(()=>{const t=parseInt(d.value),e=Math.min(t+10,400);d.value=e.toString(),updateZoom(e)})),document.getElementById("zoom-out-control")?.addEventListener("click",(()=>{const t=parseInt(d.value),e=Math.max(t-10,10);d.value=e.toString(),updateZoom(e)})),document.getElementById("zoom-reset")?.addEventListener("click",(()=>{d.value="100",updateZoom(100)})),document.getElementById("zoom-fit")?.addEventListener("click",(()=>{d.value="100",updateZoom(100)}));const l=document.getElementById("image-input");document.getElementById("import-image-btn")?.addEventListener("click",(()=>{l?.click()})),l?.addEventListener("change",(async t=>{const n=t.target.files;if(n){for(const t of Array.from(n))if(t.type.startsWith("image/"))try{await e.loadImage(t)}catch(t){}l.value=""}}));const handlePaste=async()=>{try{const t=await navigator.clipboard.read();for(const n of t)for(const t of n.types)if(t.startsWith("image/")){const s=await n.getType(t),i=new File([s],"pasted-image.png",{type:t});await e.loadImage(i)}}catch(t){}};document.getElementById("paste-btn")?.addEventListener("click",handlePaste),document.addEventListener("paste",handlePaste),document.getElementById("save-btn")?.addEventListener("click",(async()=>{const t=await e.saveToImage();if(t){const e=document.createElement("a"),n=new Date,s=n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0")+"-"+String(n.getHours()).padStart(2,"0")+"h"+String(n.getMinutes()).padStart(2,"0")+"s"+String(n.getSeconds()).padStart(2,"0");e.download=`tinh-menh-do-${s}.png`,e.href=t,document.body.appendChild(e),e.click(),document.body.removeChild(e)}}));const g=document.querySelectorAll(".tool-btn");g.forEach((t=>{t.addEventListener("click",(()=>{g.forEach((t=>t.classList.remove("active"))),t.classList.add("active")}))})),"1"===new URLSearchParams(window.location.search).get("export")&&setTimeout((()=>{handlePaste()}),1e3);