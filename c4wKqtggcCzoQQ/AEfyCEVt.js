import{jsxs,jsx,Fragment}from"react/jsx-runtime";import{useState,useRef,useEffect,useCallback}from"react";import*as d3 from"d3";import domtoimage from"dom-to-image";import html2canvas from"html2canvas";import{C as CHI}from"./CrAbeLue.js";import{d as createAstro,c as createComponent,m as maybeRenderHead,b as addAttribute,a as renderTemplate}from"./C7fEv_-K.js";import"kleur/colors";import"clsx";var GameMode=(e=>(e.CHALLENGE="CHALLENGE",e.LEARNING="LEARNING",e))(GameMode||{}),GamePhase=(e=>(e.CAN="CAN",e.CHI="CHI",e.ELEMENT="ELEMENT",e.NAYIN="NAYIN",e.CAN_ELEMENT="CAN_ELEMENT",e.CHI_ELEMENT="CHI_ELEMENT",e))(GamePhase||{});function useGameLogic({config:e,difficultyLevels:t,questionPacks:a,initialDifficulty:o="MEDIUM",initialPack:r=1}){const[s,n]=useState({correctAnswers:0,wrongAnswers:0,questionCount:0,startTime:null,elapsedTime:0,isActive:!1,isFinished:!1,selectedPack:r,selectedDifficulty:o,gameStarted:!1,showConfirmation:!1,showTimeoutPopup:!1,gameMode:GameMode.CHALLENGE,showModeSelection:!0,history:[]}),l=useRef(void 0),i=useRef(null),c=useRef(void 0);useEffect((()=>{let e=0;const a=o=>{if(!s.isActive||!i.current||s.isFinished||s.gameMode===GameMode.LEARNING)return;const r=Date.now()-i.current;if(s.gameMode===GameMode.CHALLENGE&&r>=t[s.selectedDifficulty].timeout)return n((e=>({...e,showTimeoutPopup:!0,isFinished:!0,isActive:!1}))),void(c.current&&clearTimeout(c.current));o-e>=16&&s.gameMode===GameMode.CHALLENGE&&(n((e=>({...e,elapsedTime:r}))),e=o),l.current=requestAnimationFrame(a)};return s.isActive&&!s.isFinished&&s.gameMode===GameMode.CHALLENGE&&(i.current=s.startTime,l.current=requestAnimationFrame(a)),()=>{l.current&&cancelAnimationFrame(l.current),c.current&&clearTimeout(c.current)}}),[s.isActive,s.startTime,s.isFinished,s.selectedDifficulty,s.gameMode,t]);const d=useCallback((()=>{0===s.questionCount&&n((e=>({...e,startTime:Date.now()})));const t=a.find((e=>e.id===s.selectedPack))?.questions||0;s.questionCount>=t?n((e=>({...e,isFinished:!0,isActive:!1}))):(e.generateQuestion(),n((e=>({...e,isActive:!0}))),e.onQuestionGenerated&&e.onQuestionGenerated({}))}),[s.questionCount,s.selectedPack,a,e]),g=useCallback(((t,o,r)=>{const l=Date.now(),i=s.gameMode===GameMode.CHALLENGE?l-s.startTime:0,c=e.createHistoryItem(o,r,i);if(n((e=>({...e,history:[c,...e.history],questionCount:e.questionCount+1,correctAnswers:t?e.correctAnswers+1:e.correctAnswers,wrongAnswers:t?e.wrongAnswers:e.wrongAnswers+1}))),s.gameMode===GameMode.CHALLENGE){const o=s.questionCount+1;if(o>=(a.find((e=>e.id===s.selectedPack))?.questions||0)){const a=i+s.history.reduce(((e,t)=>e+t.timeSpent),0);if(n((e=>({...e,isActive:!1,isFinished:!0,elapsedTime:a}))),e.onGameFinished){const r={correctAnswers:t?s.correctAnswers+1:s.correctAnswers,wrongAnswers:t?s.wrongAnswers:s.wrongAnswers+1,totalQuestions:o,accuracy:(t?s.correctAnswers+1:s.correctAnswers)/o*100,totalTime:a,averageTime:a/o};e.onGameFinished(r)}return}}d(),s.gameMode===GameMode.CHALLENGE&&n((e=>({...e,startTime:Date.now()}))),e.onAnswerSubmitted&&e.onAnswerSubmitted(t,r)}),[s,e,a,d]),m=useCallback((()=>{n((e=>({...e,showConfirmation:!1,showModeSelection:!1,gameStarted:!0,isFinished:!1}))),d(),n((e=>({...e,isActive:!0})))}),[d]),h=useCallback((()=>{s.gameMode===GameMode.CHALLENGE?s.gameStarted?(n((e=>({...e,showModeSelection:!0,gameStarted:!1,isFinished:!1,correctAnswers:0,wrongAnswers:0,questionCount:0,elapsedTime:0,startTime:null,history:[]}))),e.resetSpecificState()):n((e=>({...e,showConfirmation:!0}))):(n((e=>({...e,showModeSelection:!1,gameStarted:!0,isFinished:!1,correctAnswers:0,wrongAnswers:0,history:[]}))),e.resetSpecificState(),d())}),[s.gameMode,s.gameStarted,e,d]),u=useCallback((()=>{n({correctAnswers:0,wrongAnswers:0,questionCount:0,startTime:null,elapsedTime:0,isActive:!1,isFinished:!1,selectedPack:r,selectedDifficulty:o,gameStarted:!1,showConfirmation:!1,showTimeoutPopup:!1,gameMode:GameMode.CHALLENGE,showModeSelection:!0,history:[]}),e.resetSpecificState()}),[e,r,o]);return{gameState:s,startGame:h,resetGame:u,handleConfirm:m,finishQuestion:g,setGameState:n,animationFrameId:l,startTimeRef:i,timeoutRef:c}}function formatTime(e){const t=Math.floor(e/1e3),a=Math.floor(t/3600),o=Math.floor(t%3600/60),r=Math.floor(t%60),s=e%1e3;let n="";return a>0?(n+=`${a}h`,o>0&&(n+=` ${o}m`)):o>0&&(n+=`${o}m`),(r>0||!a&&!o)&&(n&&(n+=" "),n+=`${r}s`),s>0&&(n+=` ${s}ms`),n}function BaseGame({className:e="",config:t,difficultyLevels:a,questionPacks:o}){const{gameState:r,startGame:s,handleConfirm:n,finishQuestion:l,setGameState:i}=useGameLogic({config:t,difficultyLevels:a,questionPacks:o}),c=e=>{e===GameMode.LEARNING?(i((t=>({...t,gameMode:e,showModeSelection:!1,gameStarted:!0,isActive:!0,isFinished:!1,correctAnswers:0,wrongAnswers:0}))),t.resetSpecificState(),t.generateQuestion()):i((t=>({...t,gameMode:e,showModeSelection:!1})))};return jsxs("div",{className:`p-4 max-md:p-0 ${e}`,children:[r.showTimeoutPopup&&r.gameMode===GameMode.CHALLENGE&&jsx("div",{className:"bg-opacity-50 animate-fadeIn fixed inset-0 z-50 flex items-center justify-center bg-black",children:jsx("div",{className:"animate-scaleIn relative mx-4 w-full max-w-md transform rounded-xl bg-white p-8 transition-all duration-300 ease-out dark:bg-gray-800",children:jsxs("div",{className:"text-center",children:[jsx("div",{className:"mb-6 animate-pulse text-3xl font-bold text-red-500",children:"Thất bại!"}),jsx("div",{className:"mb-8 text-xl leading-relaxed text-gray-800 dark:text-gray-200",children:"Hết thời gian. Bạn cần luyện tập thêm bên phần HỌC TẬP!"}),jsx("button",{onClick:()=>{i((e=>({...e,showTimeoutPopup:!1})))},className:"transform animate-bounce rounded-full bg-linear-to-r from-orange-500 to-orange-600 px-8 py-3 text-lg font-bold text-white shadow-lg transition-all duration-200 hover:scale-105 hover:from-orange-600 hover:to-orange-700 hover:shadow-xl",children:"OK, tôi hiểu rồi!"})]})})}),r.showModeSelection||!r.gameStarted&&r.gameMode!==GameMode.LEARNING?jsxs("div",{className:"text-center",children:[r.showModeSelection&&jsxs(Fragment,{children:[jsx("h2",{className:"mb-6 text-2xl font-bold",children:"Chọn cách tự học"}),jsxs("div",{className:"mb-8 flex flex-wrap justify-center gap-4",children:[jsx("button",{onClick:()=>c(GameMode.LEARNING),className:"rounded-lg px-6 py-3 font-medium transition-all duration-200 "+(r.gameMode===GameMode.LEARNING?"bg-blue-500 text-white ring-2 ring-blue-500 ring-offset-2":"bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"),children:"Học Tập"}),jsx("button",{onClick:()=>c(GameMode.CHALLENGE),className:"rounded-lg px-6 py-3 font-medium transition-all duration-200 "+(r.gameMode===GameMode.CHALLENGE?"bg-orange-500 text-white ring-2 ring-orange-500 ring-offset-2":"bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"),children:"Thử Thách"})]})]}),r.gameMode===GameMode.CHALLENGE?jsxs(Fragment,{children:[jsxs("div",{className:"mb-8",children:[jsx("h3",{className:"mb-3 text-xl font-semibold",children:"Chọn độ khó"}),jsx("div",{className:"flex flex-wrap justify-center gap-2",children:Object.entries(a).map((([e,t])=>jsxs("button",{onClick:()=>i((t=>({...t,selectedDifficulty:e}))),className:"rounded-lg px-4 py-2 font-medium transition-all duration-200 "+(r.selectedDifficulty===e?"ring-2 ring-current ring-offset-2":"opacity-70"),style:{backgroundColor:r.selectedDifficulty===e?t.color:void 0,color:r.selectedDifficulty===e?"white":void 0},children:[t.name,jsxs("span",{className:"block text-sm opacity-75",children:[t.timeout/1e3,"s/câu"]})]},e)))})]}),jsxs("div",{className:"mb-8",children:[jsx("h3",{className:"mb-3 text-xl font-semibold",children:"Số lượng câu hỏi"}),jsx("div",{className:"flex flex-wrap justify-center gap-2",children:o.map((e=>jsx("button",{onClick:()=>i((t=>({...t,selectedPack:e.id}))),className:"rounded-lg px-4 py-2 transition-all duration-200 "+(r.selectedPack===e.id?"bg-orange-500 text-white ring-2 ring-orange-500 ring-offset-2":"bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"),children:e.name},e.id)))})]})]}):jsx("div",{className:"mb-8",children:jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:["Ở chế độ Học Tập, bạn có thể luyện tập không giới hạn thời gian và số lượng câu hỏi.",jsx("br",{}),t.description]})}),r.showConfirmation&&r.gameMode!==GameMode.LEARNING?jsxs("div",{className:"mx-auto mt-4 mb-6 max-w-md rounded-lg bg-white p-6 shadow-lg dark:bg-gray-800",children:[jsxs("p",{className:"mb-4 text-lg dark:text-gray-200",children:["Bạn đã sẵn sàng với thử thách:",jsx("br",{}),jsx("span",{className:"font-semibold",children:a[r.selectedDifficulty].name}),jsx("span",{className:"text-gray-600 dark:text-gray-400",children:" • "}),jsx("span",{className:"font-semibold",children:o.find((e=>e.id===r.selectedPack))?.name})]}),jsxs("p",{className:"mb-6 text-gray-600 dark:text-gray-400",children:["Ấn vào các cung để chọn câu trả lời. Mỗi câu có"," ",a[r.selectedDifficulty].timeout/1e3," giây để suy nghĩ."]}),jsxs("div",{className:"flex justify-center gap-4",children:[jsx("button",{onClick:n,className:"transform rounded-full bg-linear-to-r from-green-500 to-green-600 px-6 py-2 font-bold text-white shadow-md transition-all duration-200 hover:scale-105 hover:from-green-600 hover:to-green-700 hover:shadow-lg",children:"Sẵn sàng!"}),jsx("button",{onClick:()=>{i((e=>({...e,showConfirmation:!1})))},className:"transform rounded-full bg-gray-100 px-6 py-2 font-bold text-gray-800 transition-all duration-200 hover:scale-105 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600",children:"Chỉnh lại"})]})]}):jsx("button",{onClick:s,className:"mb-6 transform rounded-full bg-linear-to-r from-orange-500 to-orange-600 px-8 py-3 text-lg font-bold text-white shadow-lg transition-all duration-200 hover:scale-105 hover:from-orange-600 hover:to-orange-700 hover:shadow-xl",children:r.gameMode===GameMode.LEARNING?"Bắt đầu học":"Bắt đầu thử thách"})]}):jsx("div",{className:"mb-4 flex w-full flex-col items-center justify-center gap-4",children:(r.isFinished||r.gameMode===GameMode.LEARNING)&&jsx("button",{onClick:()=>window.location.reload(),className:"rounded bg-orange-500 px-4 py-2 font-bold text-white hover:bg-orange-600",children:r.gameMode===GameMode.LEARNING?"Chọn lại":"Chơi lại"})}),t.renderGameArea(l,{gameState:r,gameMode:r.gameMode,formatTime:formatTime}),r.isActive&&r.gameMode===GameMode.CHALLENGE&&jsxs("div",{className:"mb-4 text-lg dark:text-gray-200",children:["Đúng: ",r.correctAnswers," câu Sai: ",r.wrongAnswers," câu Thời gian:"," ",formatTime(r.elapsedTime)]}),r.isFinished&&r.gameMode===GameMode.CHALLENGE&&jsxs("div",{className:"mt-4 rounded bg-gray-100 p-4 text-center dark:bg-gray-800",children:[jsx("h3",{className:"mb-2 text-xl font-bold dark:text-gray-200",children:"Kết quả"}),jsxs("p",{className:"dark:text-gray-200",children:["Đúng: ",jsx("span",{className:"font-bold text-green-600 dark:text-green-400",children:r.correctAnswers})," câu"]}),jsxs("p",{className:"dark:text-gray-200",children:["Sai: ",jsx("span",{className:"font-bold text-red-600 dark:text-red-400",children:r.wrongAnswers})," câu"]}),jsxs("p",{className:"dark:text-gray-200",children:["Tổng thời gian hoàn thành:"," ",jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:formatTime(r.elapsedTime)})]})]})]})}const DEFAULT_CHART_CONFIG={colors:{correct:"#10b981",incorrect:"#ef4444",partial:"#f59e0b",link:"#6b7280",text:"#374151",title:"#1f2937",background:"#ffffff",border:"#e5e7eb",achievement:{pack:"#8b5cf6",difficulty:"#06b6d4",accuracy:"#10b981",average:"#f59e0b",total:"#ec4899"}}};function BaseHistoryChart({history:e,difficulty:t="MEDIUM",config:a=DEFAULT_CHART_CONFIG,getItemStatus:o,getItemDisplayText:r,getItemTooltip:s,getCustomAchievements:n,title:l="Phân tích kết quả",showShareButton:i=!1,customButtons:c,achievementLayout:d="grid",chartContainerClass:g="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800",showFullDownloadButton:m=!1,additionalStatsContent:h,fullStatsContainerRef:u}){const f=useRef(null),x=useRef(null),b=useRef(null),[p,w]=useState([]),[y,v]=useState(!1),[C,N]=useState(!1),k=useCallback((e=>{const t=Math.floor(e/1e3),a=Math.floor(t/60),o=t%60;return a>0?`${a}m ${o}s`:o>0?`${o}s`:`${e%1e3}ms`}),[]),A=useCallback((e=>"isFullyCorrect"in e&&e.isFullyCorrect||"isCorrect"in e&&e.isCorrect?"correct":"incorrect"),[]),E=useCallback((t=>"question"in t?t.question:`Item ${e.indexOf(t)+1}`),[e]),T=useCallback((e=>{const t=(o||A)(e),a=e.timeSpent?` (${k(e.timeSpent)})`:"";return`${(r||E)(e)} - ${t}${a}`}),[o,A,r,E,k]),S=useCallback((()=>{if(n)return n(e);const r=o||A,s=e.filter((e=>"correct"===r(e))).length,l=e.filter((e=>"partial"===r(e))).length,i=e.length,c=i>0?s/i*100:0,d=i>0?e.reduce(((e,t)=>e+(t.timeSpent||0)),0)/i:0,g=[{label:"Độ khó",value:t,color:a.colors.achievement.difficulty},{label:"Câu hỏi",value:`${i} câu`,color:a.colors.achievement.pack},{label:"Độ chính xác",value:`${c.toFixed(1)}%`,color:a.colors.achievement.accuracy}];return d>0&&g.push({label:"Thời gian TB",value:k(d),color:a.colors.achievement.average}),l>0&&g.push({label:"Đúng một phần",value:`${l} câu`,color:a.colors.partial||a.colors.achievement.total}),g}),[e,t,a,o,A,n,k]),M=useCallback((()=>{if(!f.current||!x.current||0===e.length)return;const t=d3.select(f.current),r=x.current.getBoundingClientRect(),n=r.width<=768,l=n?{top:50,right:30,bottom:50,left:60}:{top:60,right:40,bottom:60,left:80},i=Math.max(n?300:600,r.width-40)-l.left-l.right,c=(n?250:350)-l.top-l.bottom;t.attr("width",i+l.left+l.right).attr("height",c+l.top+l.bottom),t.selectAll("*").remove();const d=t.append("g").attr("transform",`translate(${l.left},${l.top})`),g=e.slice().reverse(),m=d3.scaleBand().domain(g.map(((e,t)=>`Câu ${t+1}`))).range([0,i]).padding(.1),h=Math.max(...g.map((e=>e.timeSpent||0))),u=d3.scaleLinear().domain([0,1.1*h]).range([c,0]);d.append("text").attr("x",i/2).attr("y",-20).attr("text-anchor","middle").style("font-size",n?"14px":"16px").style("font-weight","bold").style("fill",a.colors.title).text(n?"Thời gian trả lời":"Biểu đồ thời gian trả lời");const b=d3.axisBottom(m).ticks(n?Math.min(5,g.length):Math.min(10,g.length)),p=d3.axisLeft(u).ticks(n?4:6).tickFormat((e=>k(e)));d.append("g").attr("transform",`translate(0,${c})`).call(b).selectAll("text").style("font-size",n?"10px":"12px").style("fill",a.colors.text).attr("transform",n?"rotate(-45)":"rotate(0)").style("text-anchor",n?"end":"middle"),d.append("g").call(p).selectAll("text").style("font-size",n?"10px":"12px").style("fill",a.colors.text),n||(d.append("text").attr("transform","rotate(-90)").attr("y",0-l.left).attr("x",0-c/2).attr("dy","1em").style("text-anchor","middle").style("font-size","14px").style("fill",a.colors.text).text("Thời gian"),d.append("text").attr("transform",`translate(${i/2}, ${c+l.bottom-10})`).style("text-anchor","middle").style("font-size","14px").style("fill",a.colors.text).text("Câu hỏi"));const w=o||A;d.selectAll(".bar").data(g).enter().append("rect").attr("class","bar").attr("x",((e,t)=>m(`Câu ${t+1}`))).attr("width",m.bandwidth()).attr("y",(e=>u(e.timeSpent||0))).attr("height",(e=>c-u(e.timeSpent||0))).attr("fill",(e=>{switch(w(e)){case"correct":return a.colors.correct;case"partial":return a.colors.partial||a.colors.achievement.total;default:return a.colors.incorrect}})).on("mouseover",(function(e,t){const a=d3.select("body").append("div").attr("class","tooltip").style("position","absolute").style("background","rgba(0, 0, 0, 0.8)").style("color","white").style("padding","8px").style("border-radius","4px").style("font-size","12px").style("pointer-events","none").style("opacity",0);a.transition().duration(200).style("opacity",1),a.html((s||T)(t)).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")})).on("mouseout",(function(){d3.selectAll(".tooltip").remove()}))}),[e,a,o,A,s,T,k]);useEffect((()=>{w(S())}),[S]),useEffect((()=>{e.length>0&&M()}),[e,M]);const L=useCallback((async()=>{if(b.current&&!y){v(!0);try{if(console.log("Download triggered with history length:",e.length),console.log("History data:",e),0===e.length)return console.warn("No history data available for download"),void alert("Không có dữ liệu để tải xuống!");await new Promise((e=>setTimeout(e,100))),console.log("Component dimensions:",{width:b.current.offsetWidth,height:b.current.offsetHeight,scrollWidth:b.current.scrollWidth,scrollHeight:b.current.scrollHeight});const t=b.current.querySelector("svg");if(t){console.log("SVG dimensions:",{width:t.getAttribute("width"),height:t.getAttribute("height"),clientWidth:t.clientWidth,clientHeight:t.clientHeight}),console.log("SVG children count:",t.children.length);const a=t.querySelectorAll(".bar");if(console.log("Number of bars in SVG:",a.length),a.length!==e.length){console.warn(`SVG has ${a.length} bars but history has ${e.length} items`),console.warn("Chart may not be fully rendered, retrying..."),M(),await new Promise((e=>setTimeout(e,200)));const o=t.querySelectorAll(".bar");console.log("Number of bars after re-render:",o.length)}}else console.warn("SVG element not found!");const a=await html2canvas(b.current,{backgroundColor:"#ffffff",scale:2});console.log("Canvas dimensions:",a.width,"x",a.height);const o=a.getContext("2d"),r=o.getImageData(0,0,a.width,a.height).data.some(((e,t)=>t%4!=3&&255!==e));if(console.log("Canvas has content:",r),!r)throw console.warn("Canvas appears to be blank, trying alternative method..."),new Error("Canvas is blank");const s=document.createElement("a");s.download=`game-history-${(new Date).toISOString().split("T")[0]}.png`,s.href=a.toDataURL(),s.click()}catch(e){console.error("Error downloading chart:",e);try{await j()}catch(e){console.error("Alternative 1 failed:",e);try{await G()}catch(e){console.error("Alternative 2 also failed:",e),alert("Có lỗi khi tải ảnh. Vui lòng thử lại!")}}}finally{v(!1)}}}),[y,e,M]),j=useCallback((async()=>{if(!x.current)return;console.log("Trying alternative method with containerRef...");const e=await html2canvas(x.current,{backgroundColor:"#ffffff",scale:2});console.log("Alternative canvas dimensions:",e.width,"x",e.height);const t=document.createElement("a");t.download=`game-history-fallback-${(new Date).toISOString().split("T")[0]}.png`,t.href=e.toDataURL(),t.click()}),[]),G=useCallback((async()=>{if(!b.current)return;console.log("Trying alternative method 2 with CORS options...");const e=await html2canvas(b.current,{backgroundColor:"#ffffff",scale:2,useCORS:!0,allowTaint:!0,logging:!1});console.log("Alternative 2 canvas dimensions:",e.width,"x",e.height);const t=document.createElement("a");t.download=`game-history-alt2-${(new Date).toISOString().split("T")[0]}.png`,t.href=e.toDataURL(),t.click()}),[]),H=useCallback((async()=>{if(b.current)try{const e=await html2canvas(b.current,{backgroundColor:"#ffffff",scale:2});try{const t=await new Promise((t=>{e.toBlob((e=>t(e)),"image/png",1)}));if(!navigator.share)throw new Error("Share not supported");{const e=new File([t],"game-chart.png",{type:"image/png"});await navigator.share({files:[e],title:l,text:"Chia sẻ kết quả game từ TinhMenhDo.com"})}}catch{const t=document.createElement("a");t.download="ket-qua-game.png",t.href=e.toDataURL(),t.click()}}catch(e){console.error("Error sharing chart:",e),L()}}),[l,L]),I=useCallback((async()=>{if(!C){N(!0);try{if(console.log("Starting full stats download..."),!b.current||0===e.length)return void alert("Không có dữ liệu để tải xuống!");console.log("Target element found, dimensions:",{width:b.current.offsetWidth,height:b.current.offsetHeight,scrollWidth:b.current.scrollWidth,scrollHeight:b.current.scrollHeight}),await new Promise((e=>setTimeout(e,300)));const t=b.current.querySelector("svg");let a;t&&(console.log("Found SVG, preparing for capture:",{width:t.getAttribute("width"),height:t.getAttribute("height"),childrenCount:t.children.length}),t.style.display="block",b.current.style.display="block"),console.log("Preparing for modern capture with dom-to-image (supports OKLCH)...");let o=!1;try{console.log("Trying method 1: dom-to-image PNG"),a=await domtoimage.toPng(b.current,{width:b.current.scrollWidth,height:b.current.scrollHeight,style:{transform:"scale(1)",transformOrigin:"top left"}}),a&&a.length>1e3?(console.log("Method 1 successful - dom-to-image PNG"),o=!0):console.log("Method 1 produced invalid data")}catch(e){console.log("Method 1 failed:",e)}if(!o)try{console.log("Trying method 2: dom-to-image JPEG"),a=await domtoimage.toJpeg(b.current,{width:b.current.scrollWidth,height:b.current.scrollHeight,quality:1,bgcolor:"#ffffff"}),a&&a.length>1e3?(console.log("Method 2 successful - dom-to-image JPEG"),o=!0):console.log("Method 2 produced invalid data")}catch(e){console.log("Method 2 failed:",e)}if(!o)try{console.log("Trying method 3: html2canvas fallback");a=(await html2canvas(b.current,{backgroundColor:"#ffffff",scale:1})).toDataURL("image/png",1),a&&a.length>1e3&&(console.log("Method 3 successful - html2canvas fallback"),o=!0)}catch(e){console.log("Method 3 failed:",e)}if(!o&&x.current)try{console.log("Trying method 4: Chart container only");a=(await html2canvas(x.current,{backgroundColor:"#ffffff",scale:2})).toDataURL("image/png",1),a&&a.length>1e3&&(console.log("Method 4 successful - chart only"),o=!0)}catch(e){console.log("Method 4 failed:",e)}if(!o||!a)throw new Error("All capture methods failed");console.log("Capture successful, preparing download...");const r=document.createElement("a");r.download=`thong-ke-chi-tiet-${(new Date).toISOString().split("T")[0]}.png`,r.href=a,document.body.appendChild(r),r.click(),document.body.removeChild(r),console.log("Download completed successfully")}catch(e){console.error("All download methods failed:",e),alert("Có lỗi khi tải ảnh thống kê. Vui lòng thử lại!")}finally{N(!1)}}}),[C,e]);return jsxs("div",{ref:b,className:"w-full",children:[jsxs("div",{className:"mb-6",children:[jsxs("div",{className:"mb-4 flex flex-col items-center justify-between gap-4 sm:flex-row",children:[jsx("h3",{className:"text-center text-xl font-bold dark:text-gray-200",children:l}),m&&jsx("button",{onClick:I,disabled:C,className:"flex items-center gap-2 rounded-lg px-4 py-2 text-sm text-white transition-colors "+(C?"cursor-not-allowed bg-gray-400":"bg-green-500 hover:bg-green-600"),children:jsxs(Fragment,C?{children:[jsxs("svg",{className:"h-4 w-4 animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Đang tải thống kê..."]}:{children:[jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z",clipRule:"evenodd"})}),"Tải toàn bộ thống kê"]})})]}),jsx("div","grid"===d?{className:"mb-6 grid grid-cols-1 gap-3 sm:grid-cols-2 md:grid-cols-3",children:p.map(((e,t)=>jsx("div",{className:"rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800",children:jsxs("div",{className:"flex items-center",children:[jsx("div",{className:"mr-3 h-3 w-3 rounded-full",style:{backgroundColor:e.color}}),jsxs("div",{children:[jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:e.label}),jsx("div",{className:"text-lg font-semibold dark:text-gray-200",children:e.value})]})]})},t)))}:{className:"mb-6 flex flex-wrap justify-center gap-4",children:p.map(((e,t)=>jsxs("div",{className:"flex items-center rounded-lg border border-gray-200 bg-white px-4 py-2 shadow-sm dark:border-gray-700 dark:bg-gray-800",children:[jsx("div",{className:"mr-2 h-2 w-2 rounded-full",style:{backgroundColor:e.color}}),jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:[e.label,":"]}),jsx("span",{className:"ml-1 font-semibold dark:text-gray-200",children:e.value})]},t)))})]}),jsxs("div",{className:g,children:[jsxs("div",{className:"mb-4 flex flex-col items-center justify-between gap-4 sm:flex-row",children:[jsx("h4",{className:"text-lg font-semibold dark:text-gray-200",children:"Biểu đồ chi tiết từng câu"}),jsxs("div",{className:"flex gap-2",children:[i&&jsxs("button",{onClick:H,className:"flex items-center gap-2 rounded-lg bg-orange-500 px-4 py-2 text-sm text-white transition-colors hover:bg-orange-600",children:[jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:jsx("path",{d:"M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"})}),"Chia sẻ"]}),jsx("button",{onClick:L,disabled:y,className:"flex items-center gap-2 rounded-lg px-4 py-2 text-sm text-white transition-colors "+(y?"cursor-not-allowed bg-gray-400":"bg-blue-500 hover:bg-blue-600"),children:jsxs(Fragment,y?{children:[jsxs("svg",{className:"h-4 w-4 animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Đang tải..."]}:{children:[jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z",clipRule:"evenodd"})}),"Tải ảnh"]})}),c]})]}),jsx("div",{ref:x,className:"w-full overflow-x-auto",children:jsx("svg",{ref:f,className:"w-full",style:{backgroundColor:"#ffffff"}})})]}),h&&jsx("div",{className:"mt-6",children:h})]})}const BASE_QUESTIONS=14,DEFAULT_QUESTION_PACKS=[{id:1,name:"14 câu",questions:14,color:"#10b981"},{id:2,name:"28 câu",questions:28,color:"#f59e0b"},{id:3,name:"42 câu",questions:42,color:"#f97316"},{id:4,name:"56 câu",questions:56,color:"#ef4444"}],CUNG=CHI.reduce(((e,t,a)=>(e[t]=a+1,e)),{}),CUNG_POSITIONS=[{name:"Tý",position:"bottom-[2%] right-[27%]"},{name:"Sửu",position:"bottom-[2%] right-[52%]"},{name:"Dần",position:"bottom-[2%] left-[2%]"},{name:"Mão",position:"bottom-[27%] left-[2%]"},{name:"Thìn",position:"top-[27%] left-[2%]"},{name:"Tị",position:"top-[2%] left-[2%]"},{name:"Ngọ",position:"top-[2%] left-[27%]"},{name:"Mùi",position:"top-[2%] right-[27%]"},{name:"Thân",position:"top-[2%] right-[2%]"},{name:"Dậu",position:"top-[27%] right-[2%]"},{name:"Tuất",position:"bottom-[27%] right-[2%]"},{name:"Hợi",position:"bottom-[2%] right-[2%]"}],STANDARD_DIFFICULTY_LEVELS={EASY:{name:"Dễ",timeout:25e3,color:"#10b981"},MEDIUM:{name:"Trung bình",timeout:2e4,color:"#f59e0b"},HARD:{name:"Khó",timeout:15e3,color:"#f97316"},EXPERT:{name:"Siêu khó",timeout:1e4,color:"#ef4444"}},CAN_CHI_DIFFICULTY_LEVELS={EASY:{name:"Dễ",timeout:3e4,color:"#10b981"},MEDIUM:{name:"Trung bình",timeout:25e3,color:"#f59e0b"},HARD:{name:"Khó",timeout:2e4,color:"#f97316"},EXPERT:{name:"Siêu khó",timeout:15e3,color:"#ef4444"}},ELEMENT_COLORS={"Thủy":"bg-blue-500 hover:bg-blue-600 text-white","Mộc":"bg-green-500 hover:bg-green-600 text-white",Kim:"bg-gray-400 hover:bg-gray-600 text-white","Thổ":"bg-yellow-500 hover:bg-yellow-600 text-white","Hỏa":"bg-red-500 hover:bg-red-600 text-white"},createCungColors=e=>({"Tị":{bg:e,text:"text-red-500 dark:text-red-400"},"Ngọ":{bg:e,text:"text-red-600 dark:text-red-400"},"Mùi":{bg:e,text:"text-yellow-500 dark:text-yellow-400"},"Thân":{bg:e,text:"text-gray-600 dark:text-gray-300"},"Thìn":{bg:e,text:"text-yellow-500 dark:text-yellow-400"},"Dậu":{bg:e,text:"text-gray-600 dark:text-gray-300"},"Mão":{bg:e,text:"text-green-600 dark:text-green-400"},"Tuất":{bg:e,text:"text-yellow-600 dark:text-yellow-400"},"Dần":{bg:e,text:"text-green-500 dark:text-green-400"},"Sửu":{bg:e,text:"text-yellow-600 dark:text-yellow-400"},"Tý":{bg:e,text:"text-blue-600 dark:text-blue-400"},"Hợi":{bg:e,text:"text-blue-500 dark:text-blue-400"}}),THEME_VARIANTS={SLATE:"bg-slate-100 dark:bg-slate-800",ORANGE:"bg-orange-50 dark:bg-slate-800"},CHART_CONTAINER_CLASSES="relative mx-auto mb-6 h-[500px] max-h-[95vw] w-[500px] max-w-[95vw] rounded-2xl border border-gray-200 bg-gradient-to-br from-white to-gray-50 shadow-xl max-md:-ml-2 dark:border-gray-700 dark:from-gray-800 dark:to-gray-900",QUESTION_PANEL_CLASSES="w-full max-w-[250px] rounded-xl border border-blue-200 bg-gradient-to-br from-white to-blue-50 p-2 font-medium shadow-xl backdrop-blur-sm dark:border-gray-600 dark:from-gray-800 dark:to-gray-900",createGetCungClassName=e=>(t,a,o,r=!1)=>`${`absolute w-[22%] h-[22%] ${e[t].bg} p-3 max-md:p-2 rounded-xl shadow-xl border border-gray/20 dark:border-gray-600/30 transition-all duration-300 hover:shadow-2xl hover:scale-105`} ${a&&t===o?"ring-1 ring-orange-200 scale-110 shadow-2xl z-50":"z-10"} ${r?"bg-yellow-100 dark:bg-yellow-900":""}`,createGetCungClassNameClickable=e=>(t,a)=>`${`absolute w-[22%] h-[22%] rounded-2xl ${e[t].bg} p-3 max-md:p-2 shadow-xl border border-gray/20 dark:border-gray-600/30 transition-all duration-300 hover:shadow-2xl hover:scale-105 cursor-pointer hover:bg-yellow-50 dark:hover:bg-yellow-900`} ${a?"z-40 bg-yellow-100 dark:bg-yellow-900":"z-10"}`,tuviLessons=[{slug:"/hoc-tu-vi/can-chi-tuong-tac",title:"Tương tác Thiên Can Địa Chi"},{slug:"/hoc-tu-vi/nho-luc-thap-hoa-giap",title:"Tự học tử vi Lục Thập Hoa Giáp & Nạp Âm"},{slug:"/hoc-tu-vi/tim-can-chi-tu-nam-duong-lich",title:"Tự tìm Can Chi từ năm dương lịch"},{slug:"/hoc-tu-vi/nho-vi-tri-14-chinh-tinh",title:"Nhớ vị trí 14 chính tinh"}],$$Astro=createAstro("https://tinhmenhdo.com"),$$RelatedLessons=createComponent(((e,t,a)=>{const o=e.createAstro($$Astro,t,a);o.self=$$RelatedLessons;const{currentSlug:r}=o.props,s=tuviLessons.filter((e=>e.slug!==r));return renderTemplate`${maybeRenderHead()}<div class="mx-auto px-4 pb-10"> <h2 class="mb-4 text-2xl font-bold">Các bài học liên quan</h2> <ul class="list-disc pl-5 text-md"> ${s.map((e=>renderTemplate`<li> <a${addAttribute(e.slug,"href")} class="text-blue-600 hover:underline py-1 inline-block"${addAttribute(e.title,"title")}> ${e.title} </a> </li>`))} </ul> </div>`}),"/root/code/tmd_astro/src/components/tuvi/RelatedLessons.astro",void 0);export{$$RelatedLessons as $,BaseGame as B,CUNG_POSITIONS as C,DEFAULT_QUESTION_PACKS as D,ELEMENT_COLORS as E,GamePhase as G,QUESTION_PANEL_CLASSES as Q,STANDARD_DIFFICULTY_LEVELS as S,THEME_VARIANTS as T,createCungColors as a,CHART_CONTAINER_CLASSES as b,createGetCungClassName as c,BaseHistoryChart as d,createGetCungClassNameClickable as e,CUNG as f,CAN_CHI_DIFFICULTY_LEVELS as g};