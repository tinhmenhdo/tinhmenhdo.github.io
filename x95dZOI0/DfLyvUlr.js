import{K as g}from"./CNuNv4A4.js";import"./BScVxmeO.js";import"./Cpj98o6Y.js";class v{static instance=null;stage;layer;currentShape=null;isDrawing=!1;mode="rect";startPos={x:0,y:0};isProcessingImage=!1;lastProcessedImage=null;isPanning=!1;lastCenter=null;history=[];MAX_HISTORY=50;points=[];textNode=null;isScaling=!1;scaleNode=null;lastMouseX=0;constructor(){document.getElementById("drawing-container"),this.stage=new g.Stage({container:"drawing-container",width:window.innerWidth,height:window.innerHeight}),this.layer=new g.Layer,this.stage.add(this.layer),window.addEventListener("resize",()=>{this.stage.width(window.innerWidth),this.stage.height(window.innerHeight)}),this.initializeEvents(),this.initializeToolbar()}static getInstance(){return v.instance||(v.instance=new v),v.instance}initializeEvents(){this.stage.on("contextmenu",e=>{e.evt.preventDefault();const t=e.target,s=this.stage.container().getBoundingClientRect(),a=e.evt.clientX-s.left,n=e.evt.clientY-s.top;if((()=>{["shape-context-menu"].forEach(r=>{const m=document.getElementById(r);m&&(m.classList.add("hidden"),m.selectedNode=null)})})(),t instanceof g.Node&&!(t instanceof g.Stage)&&!(t instanceof g.Layer)){const o=document.getElementById("shape-context-menu");if(o){o.style.left=`${a}px`,o.style.top=`${n}px`,o.classList.remove("hidden"),o.selectedNode=t;const r=o.querySelector(".drag-text");r&&(r.textContent=t.draggable()?"Khóa di chuyển":"Mở khóa di chuyển"),o.querySelectorAll('input[type="range"]').forEach(b=>{b.value="100";const w=b.nextElementSibling;w&&(w.textContent="100%")})}}}),this.stage.on("mousedown touchstart",e=>{if(this.isScaling){e.target===this.scaleNode&&(this.lastMouseX=e.evt.clientX);return}if(e.evt.button===2){this.isPanning=!0,this.lastCenter=this.stage.getPointerPosition(),document.body.style.cursor="grabbing";return}this.isDrawing=!0;const t=this.stage.getPointerPosition(),s=this.stage.scaleX(),a=this.stage.position(),n={x:(t.x-a.x)/s,y:(t.y-a.y)/s};switch(this.startPos=n,this.mode){case"pencil":this.points=[n.x,n.y],this.currentShape=new g.Line({points:this.points,stroke:"black",strokeWidth:2,lineCap:"round",lineJoin:"round",draggable:!0});break;case"rect":this.currentShape=new g.Rect({x:n.x,y:n.y,width:0,height:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"circle":this.currentShape=new g.Circle({x:n.x,y:n.y,radius:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"line":this.currentShape=new g.Line({points:[n.x,n.y,n.x,n.y],stroke:"black",strokeWidth:2,draggable:!0});break;case"text":{const i=document.querySelector('textarea[data-type="drawing-text"]');i&&i.dispatchEvent(new Event("blur"));const o=this.stage.getPointerPosition(),r=this.stage.scaleX(),m=this.stage.position(),b={x:(o.x-m.x)/r,y:(o.y-m.y)/r},w=new g.Text({x:b.x,y:b.y,text:"",fontSize:16,fill:"black",draggable:!0,width:200,cursor:"move"});this.layer.add(w),this.textNode=w;const y=document.createElement("textarea");y.setAttribute("data-type","drawing-text"),document.body.appendChild(y);const I=this.stage.container().getBoundingClientRect(),L={x:o.x+I.left,y:o.y+I.top};Object.assign(y.style,{position:"fixed",top:`${L.y}px`,left:`${L.x}px`,width:"200px",minHeight:"50px",padding:"5px",fontSize:"16px",border:"2px solid #4299e1",borderRadius:"4px",background:"white",outline:"none",resize:"none",overflow:"hidden",zIndex:"10000",margin:"0",lineHeight:"1.2",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",display:"block"}),setTimeout(()=>{y.focus()},0),y.addEventListener("input",()=>{y.style.height="auto",y.style.height=`${y.scrollHeight}px`,this.textNode&&(this.textNode.text(y.value),this.layer.batchDraw())});const N=()=>{y.remove(),this.textNode&&(this.textNode.text().trim()===""?this.textNode.destroy():(this.history.push({node:this.textNode.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.textNode=null,this.layer.batchDraw())};y.addEventListener("blur",N),y.addEventListener("keydown",M=>{M.key==="Enter"&&!M.shiftKey&&y.blur()});break}}this.currentShape&&this.layer.add(this.currentShape)}),this.stage.on("mousemove touchmove",e=>{if(this.isScaling&&this.scaleNode&&this.lastMouseX!==0){e.evt.preventDefault();const o=e.evt.clientX-this.lastMouseX>0?1.1:.9,m=this.scaleNode.scaleX()*o;m>=.1&&m<=50&&(this.scaleNode.scale({x:m,y:m}),this.layer.batchDraw()),this.lastMouseX=e.evt.clientX;return}if(this.isPanning&&this.lastCenter){e.evt.preventDefault();const i=this.stage.getPointerPosition(),o=i.x-this.lastCenter.x,r=i.y-this.lastCenter.y;this.stage.position({x:this.stage.x()+o,y:this.stage.y()+r}),this.stage.batchDraw(),this.lastCenter=i;return}if(!this.isDrawing)return;const t=this.stage.getPointerPosition(),s=this.stage.scaleX(),a=this.stage.position(),n={x:(t.x-a.x)/s,y:(t.y-a.y)/s};switch(this.mode){case"pencil":{this.points=this.points.concat([n.x,n.y]),this.currentShape.points(this.points);break}case"rect":{const i=this.currentShape,o=n.x-this.startPos.x,r=n.y-this.startPos.y;o<0?(i.x(n.x),i.width(Math.abs(o))):(i.x(this.startPos.x),i.width(o)),r<0?(i.y(n.y),i.height(Math.abs(r))):(i.y(this.startPos.y),i.height(r));break}case"circle":{const i=this.currentShape,o=Math.sqrt(Math.pow(n.x-this.startPos.x,2)+Math.pow(n.y-this.startPos.y,2));i.radius(o);break}case"line":{this.currentShape.points([this.startPos.x,this.startPos.y,n.x,n.y]);break}}this.layer.batchDraw()}),this.stage.on("mouseup touchend",()=>{this.currentShape&&(this.history.push(this.currentShape.clone()),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null}),this.stage.on("mouseleave",()=>{this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null}),document.addEventListener("click",e=>{const t=e.target;["shape-context-menu"].forEach(a=>{const n=document.getElementById(a);n&&!n.contains(t)&&(n.classList.add("hidden"),n.selectedNode=null)})}),document.getElementById("delete-shape-btn")?.addEventListener("click",()=>{const e=document.getElementById("shape-context-menu");if(e){const t=e.selectedNode;t&&(t.destroy(),this.layer.batchDraw(),this.history.push({type:"delete",node:t.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),e.classList.add("hidden"),e.selectedNode=null}});const u=(e,t,s)=>{const a=e.getClientRect(),n=s/100;if(t==="width"){const i=a.width*n;e.scaleX(i/a.width)}else{const i=a.height*n;e.scaleY(i/a.height)}this.layer.batchDraw()};document.querySelectorAll('input[type="range"][data-scale]').forEach(e=>{e.addEventListener("input",t=>{const s=t.target,a=parseInt(s.value),n=s.dataset.scale,i=document.getElementById("shape-context-menu");if(i){const o=i.selectedNode;if(o){u(o,n,a);const r=s.nextElementSibling;r&&(r.textContent=`${a}%`)}}})}),document.getElementById("toggle-drag-btn")?.addEventListener("click",()=>{const e=document.getElementById("shape-context-menu");if(e){const t=e.selectedNode;if(t){const s=t.draggable();t.draggable(!s);const a=e.querySelector(".drag-text");a&&(a.textContent=s?"Mở khóa di chuyển":"Khóa di chuyển"),this.history.push({type:"dragToggle",node:t.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift(),this.layer.batchDraw()}e.classList.add("hidden"),e.selectedNode=null}}),this.layer.on("mouseover",e=>{const t=e.target;t instanceof g.Node&&!(t instanceof g.Stage)&&!(t instanceof g.Layer)&&(t.draggable()&&(document.body.style.cursor="move"),t.getAttr("isScaling")&&(document.body.style.cursor="ew-resize"))}),this.layer.on("mouseout",()=>{document.body.style.cursor="default"}),document.getElementById("toggle-drag-btn")?.addEventListener("click",()=>{const e=document.getElementById("shape-context-menu");if(e){const t=e.selectedNode;if(t){const s=t.draggable();t.draggable(!s),t===this.layer.getIntersection(this.stage.getPointerPosition())&&(document.body.style.cursor=s?"default":"move")}}}),this.stage.on("wheel",e=>{e.evt.preventDefault();const t=this.stage.scaleX(),s=this.stage.getPointerPosition(),a={x:(s.x-this.stage.x())/t,y:(s.y-this.stage.y())/t},n=e.evt.deltaY>0?-1:1,i=1.1,o=n>0?t*i:t/i;if(o<.1||o>10)return;this.stage.scale({x:o,y:o});const r={x:s.x-a.x*o,y:s.y-a.y*o};this.stage.position(r),this.stage.batchDraw()}),document.getElementById("enable-scale-btn")?.addEventListener("click",e=>{e.stopPropagation();const t=document.getElementById("shape-context-menu");if(t){const s=t.selectedNode;if(s){this.scaleNode=s,this.isScaling=!0;const a=s.draggable();s.setAttr("savedDraggable",a),s.draggable(!1),document.body.style.cursor="ew-resize",s.setAttr("isScaling",!0),setTimeout(()=>{t.classList.add("hidden")},100)}}}),this.stage.on("mousedown",e=>{this.isScaling&&e.target===this.scaleNode&&(this.lastMouseX=e.evt.clientX)}),this.stage.on("mousemove",e=>{if(this.isScaling&&this.scaleNode&&this.lastMouseX!==0){e.evt.preventDefault();const s=1+(e.evt.clientX-this.lastMouseX)*5e-4,n=this.scaleNode.scaleX()*s;n>=.1&&n<=50&&(this.scaleNode.scale({x:n,y:n}),this.layer.batchDraw()),this.lastMouseX=e.evt.clientX}}),this.stage.on("mouseup",()=>{this.lastMouseX=0}),document.addEventListener("click",e=>{if(this.isScaling&&e.target!==this.scaleNode?.getStage()?.container()){if(this.scaleNode){const t=this.scaleNode.getAttr("savedDraggable");typeof t=="boolean"&&this.scaleNode.draggable(t)}this.isScaling=!1,this.scaleNode=null,this.lastMouseX=0,document.body.style.cursor="default"}}),this.stage.on("mouseover",e=>{const t=e.target;this.isScaling&&t===this.scaleNode?document.body.style.cursor="ew-resize":t instanceof g.Node&&!(t instanceof g.Stage)&&!(t instanceof g.Layer)&&t.draggable()&&(document.body.style.cursor="move")});const h=document.getElementById("zoom-slider"),l=document.getElementById("zoom-level"),f=document.getElementById("zoom-in-control"),p=document.getElementById("zoom-out-control"),c=document.getElementById("zoom-reset"),d=e=>{const t=e/100,s=this.stage.scaleX(),a={x:this.stage.width()/2,y:this.stage.height()/2},n={x:(a.x-this.stage.x())/s,y:(a.y-this.stage.y())/s};this.stage.scale({x:t,y:t});const i={x:a.x-n.x*t,y:a.y-n.y*t};this.stage.position(i),this.stage.batchDraw(),l&&(l.textContent=`${Math.round(e)}%`)};h?.addEventListener("input",e=>{const t=parseInt(e.target.value);d(t)}),f?.addEventListener("click",()=>{const e=parseInt(h.value),t=Math.min(e+10,400);h.value=t.toString(),d(t)}),p?.addEventListener("click",()=>{const e=parseInt(h.value),t=Math.max(e-10,10);h.value=t.toString(),d(t)}),c?.addEventListener("click",()=>{h.value="100",d(100)}),this.stage.on("wheel",e=>{e.evt.preventDefault();const t=this.stage.scaleX(),s=this.stage.getPointerPosition(),a={x:(s.x-this.stage.x())/t,y:(s.y-this.stage.y())/t},n=e.evt.deltaY>0?-1:1,i=parseInt(h.value),o=Math.min(Math.max(i+n*10,10),400);h.value=o.toString();const r=o/100;this.stage.scale({x:r,y:r});const m={x:s.x-a.x*r,y:s.y-a.y*r};this.stage.position(m),this.stage.batchDraw(),l&&(l.textContent=`${Math.round(o)}%`)}),document.getElementById("zoom-fit")?.addEventListener("click",()=>{const e=document.getElementById("zoom-slider"),t=document.getElementById("zoom-level");e.value="100",this.stage.scale({x:1,y:1}),this.stage.position({x:0,y:0}),this.stage.batchDraw(),t&&(t.textContent="100%")})}initializeToolbar(){document.getElementById("rect-btn")?.addEventListener("click",()=>this.mode="rect"),document.getElementById("circle-btn")?.addEventListener("click",()=>this.mode="circle"),document.getElementById("line-btn")?.addEventListener("click",()=>this.mode="line"),document.getElementById("pencil-btn")?.addEventListener("click",()=>this.mode="pencil"),document.getElementById("text-btn")?.addEventListener("click",()=>this.mode="text"),document.getElementById("zoom-in-btn")?.addEventListener("click",()=>{const c=this.stage.scaleX()*1.2;this.stage.scale({x:c,y:c}),this.layer.batchDraw()}),document.getElementById("zoom-out-btn")?.addEventListener("click",()=>{const c=this.stage.scaleX()/1.2;this.stage.scale({x:c,y:c}),this.layer.batchDraw()}),document.addEventListener("paste",async c=>{c.preventDefault();const d=Array.from(c.clipboardData?.items||[]);for(const e of d)if(e.type.startsWith("image/")){const t=e.getAsFile();if(t)try{await this.loadImage(t)}catch(s){console.error("Error loading pasted image:",s)}}}),document.getElementById("paste-btn")?.addEventListener("click",async()=>{try{const c=await navigator.clipboard.read();for(const d of c)for(const e of d.types)if(e.startsWith("image/")){const t=await d.getType(e),s=new File([t],"pasted-image.png",{type:e});await this.loadImage(s)}}catch(c){console.error("Error reading clipboard:",c)}}),document.getElementById("import-image-btn")?.addEventListener("click",()=>{document.getElementById("image-input")?.click()});const u=document.getElementById("image-input");u?.addEventListener("change",async c=>{const d=c.target.files;if(d){for(const e of Array.from(d))if(e.type.startsWith("image/"))try{await this.loadImage(e)}catch(t){console.error("Error loading image file:",t)}u.value=""}});const h=document.getElementById("drawing-container");h&&(h.addEventListener("dragover",c=>{c.preventDefault()}),h.addEventListener("drop",async c=>{c.preventDefault();const d=c.dataTransfer?.files;if(d){for(const e of Array.from(d))if(e.type.startsWith("image/"))try{await this.loadImage(e)}catch(t){console.error("Error loading dropped image:",t)}}})),document.getElementById("undo-btn")?.addEventListener("click",()=>{this.undo()});const l=document.getElementById("fullscreen-btn"),f=document.getElementById("watermark"),p=document.querySelector("header");l?.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{if(f?.classList.add("hidden"),p?.classList.remove("hidden"),l){const c=l.querySelector("svg");c&&(c.innerHTML=`
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                  `),l.textContent&&(l.lastChild.textContent="Toàn màn hình")}}):document.documentElement.requestFullscreen().then(()=>{if(f?.classList.remove("hidden"),p?.classList.add("hidden"),l){const c=l.querySelector("svg");c&&(c.innerHTML=`
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" />
                  `),l.textContent&&(l.lastChild.textContent="Thoát toàn màn hình")}})}),document.addEventListener("fullscreenchange",()=>{if(!document.fullscreenElement&&(f?.classList.add("hidden"),p?.classList.remove("hidden"),l)){const c=l.querySelector("svg");c&&(c.innerHTML=`
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                `),l.textContent&&(l.lastChild.textContent="Toàn màn hình")}})}loadImage(u){return new Promise((h,l)=>{const f=new FileReader;f.onload=()=>{const p=new Image;p.onload=()=>{const c=this.stage.width()*.8,d=this.stage.height()*.8;let e=p.width,t=p.height;if(e>c){const i=c/e;e=c,t*=i}if(t>d){const i=d/t;t=d,e*=i}const s=(this.stage.width()-e)/2,a=(this.stage.height()-t)/2,n=new g.Image({x:s,y:a,image:p,width:e,height:t,draggable:!0,cursor:"move"});this.layer.add(n),this.history.push({node:n.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift(),this.layer.batchDraw(),h()},p.onerror=l,p.src=f.result},f.onerror=l,f.readAsDataURL(u)})}undo(){if(this.history.length>0){const u=this.history[this.history.length-1];switch(u.type){case"delete":this.layer.add(u.node.clone());break;case"dragToggle":const h=this.layer.findOne(f=>f.id()===u.node.id());h&&h.draggable(!h.draggable());break;default:const l=this.layer.children[this.layer.children.length-1];l&&l.destroy();break}this.history.pop(),this.layer.batchDraw()}}}const B=document.getElementById("menu-btn"),D=document.getElementById("close-toolbar"),E=document.getElementById("toolbar");let S=!1;const C=()=>{S=!0,E?.classList.add("open")},k=()=>{S=!1,E?.classList.remove("open")};B?.addEventListener("click",x=>{x.stopPropagation(),S?k():C()});D?.addEventListener("click",()=>{k()});document.addEventListener("click",x=>{const u=x.target;S&&!E?.contains(u)&&u!==B&&!u.closest(".tool-btn")&&k()});E?.addEventListener("click",x=>{x.stopPropagation()});const P=document.querySelectorAll(".tool-btn");P.forEach(x=>{x.addEventListener("click",()=>{P.forEach(u=>u.classList.remove("active")),x.classList.add("active")})});v.getInstance();
