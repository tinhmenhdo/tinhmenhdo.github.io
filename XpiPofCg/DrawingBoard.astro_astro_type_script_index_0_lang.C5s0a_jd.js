import{K as d}from"./index.1aORmCXs.js";import"./_commonjsHelpers.Cpj98o6Y.js";class b{static instance=null;stage;layer;currentShape=null;isDrawing=!1;mode="rect";startPos={x:0,y:0};isProcessingImage=!1;lastProcessedImage=null;isPanning=!1;lastCenter=null;history=[];MAX_HISTORY=50;points=[];textNode=null;isScaling=!1;scaleNode=null;lastMouseX=0;background;constructor(){this.initializeStage(),this.initializeEvents()}static getInstance(){return b.instance||(b.instance=new b),b.instance}getStage(){return this.stage}initializeStage(){const t=document.getElementById("drawing-container");t&&(this.stage=new d.Stage({container:"drawing-container",width:t.clientWidth,height:t.clientHeight,fill:"white"}),this.layer=new d.Layer,this.stage.add(this.layer))}initializeEvents(){this.stage.on("contextmenu",t=>{t.evt.preventDefault();const e=t.target,a=this.stage.container().getBoundingClientRect(),r=t.evt.clientX-a.left,o=t.evt.clientY-a.top;if((()=>{["shape-context-menu"].forEach(l=>{const c=document.getElementById(l);c&&(c.classList.add("hidden"),c.selectedNode=null)})})(),e instanceof d.Node&&!(e instanceof d.Stage)&&!(e instanceof d.Layer)){const n=document.getElementById("shape-context-menu");if(n){n.style.left=`${r}px`,n.style.top=`${o}px`,n.classList.remove("hidden"),n.selectedNode=e;const l=n.querySelector(".drag-text");l&&(l.textContent=e.draggable()?"Khóa di chuyển":"Mở khóa di chuyển"),n.querySelectorAll('input[type="range"]').forEach(g=>{g.value="100";const y=g.nextElementSibling;y&&(y.textContent="100%")})}}}),this.stage.on("mousedown touchstart",t=>{const e=t.target;if(e instanceof d.Node&&!(e instanceof d.Stage)&&!(e instanceof d.Layer)&&e.draggable())return;if(this.isScaling){t.target===this.scaleNode&&(this.lastMouseX=t.evt.clientX);return}if(t.evt.button===2){this.isPanning=!0,this.lastCenter=this.stage.getPointerPosition(),document.body.style.cursor="grabbing";return}if(!(t.target instanceof d.Stage)&&!(t.target instanceof d.Layer))return;this.isDrawing=!0;const r=this.stage.getPointerPosition(),o=this.stage.scaleX(),i=this.stage.position(),n={x:(r.x-i.x)/o,y:(r.y-i.y)/o};switch(this.startPos=n,this.mode){case"pencil":this.points=[n.x,n.y],this.currentShape=new d.Line({points:this.points,stroke:"black",strokeWidth:2,lineCap:"round",lineJoin:"round",draggable:!0});break;case"rect":this.currentShape=new d.Rect({x:n.x,y:n.y,width:0,height:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"circle":this.currentShape=new d.Circle({x:n.x,y:n.y,radius:0,stroke:"black",strokeWidth:2,draggable:!0});break;case"line":this.currentShape=new d.Line({points:[n.x,n.y,n.x,n.y],stroke:"black",strokeWidth:2,draggable:!0});break;case"text":{const l=document.querySelector('textarea[data-type="drawing-text"]');l&&l.dispatchEvent(new Event("blur"));const c=this.stage.getPointerPosition(),g=this.stage.scaleX(),y=this.stage.position(),w={x:(c.x-y.x)/g,y:(c.y-y.y)/g},E=new d.Text({x:w.x,y:w.y,text:"",fontSize:16,fill:"black",draggable:!0,width:200,cursor:"move"});this.layer.add(E),this.textNode=E;const h=document.createElement("textarea");h.setAttribute("data-type","drawing-text"),document.body.appendChild(h);const u=this.stage.container().getBoundingClientRect(),p={x:c.x+u.left,y:c.y+u.top};Object.assign(h.style,{position:"fixed",top:`${p.y}px`,left:`${p.x}px`,width:"200px",minHeight:"50px",padding:"5px",fontSize:"16px",border:"2px solid #4299e1",borderRadius:"4px",background:"white",outline:"none",resize:"none",overflow:"hidden",zIndex:"10000",margin:"0",lineHeight:"1.2",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",display:"block"}),setTimeout(()=>{h.focus()},0),h.addEventListener("input",()=>{h.style.height="auto",h.style.height=`${h.scrollHeight}px`,this.textNode&&(this.textNode.text(h.value),this.layer.batchDraw())});const S=()=>{h.remove(),this.textNode&&(this.textNode.text().trim()===""?this.textNode.destroy():(this.history.push({node:this.textNode.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.textNode=null,this.layer.batchDraw())};h.addEventListener("blur",S),h.addEventListener("keydown",k=>{k.key==="Enter"&&!k.shiftKey&&h.blur()});break}}this.currentShape&&this.layer.add(this.currentShape)}),this.stage.on("mousemove touchmove",t=>{if(this.isScaling&&this.scaleNode&&this.lastMouseX!==0){t.evt.preventDefault();const n=t.evt.clientX-this.lastMouseX>0?1.1:.9,c=this.scaleNode.scaleX()*n;c>=.1&&c<=50&&(this.scaleNode.scale({x:c,y:c}),this.layer.batchDraw()),this.lastMouseX=t.evt.clientX;return}if(this.isPanning&&this.lastCenter){t.evt.preventDefault();const i=this.stage.getPointerPosition(),n=i.x-this.lastCenter.x,l=i.y-this.lastCenter.y;this.stage.position({x:this.stage.x()+n,y:this.stage.y()+l}),this.stage.batchDraw(),this.lastCenter=i;return}if(!this.isDrawing)return;const e=this.stage.getPointerPosition(),a=this.stage.scaleX(),r=this.stage.position(),o={x:(e.x-r.x)/a,y:(e.y-r.y)/a};switch(this.mode){case"pencil":{this.points=this.points.concat([o.x,o.y]),this.currentShape.points(this.points);break}case"rect":{const i=this.currentShape,n=o.x-this.startPos.x,l=o.y-this.startPos.y;n<0?(i.x(o.x),i.width(Math.abs(n))):(i.x(this.startPos.x),i.width(n)),l<0?(i.y(o.y),i.height(Math.abs(l))):(i.y(this.startPos.y),i.height(l));break}case"circle":{const i=this.currentShape,n=Math.sqrt(Math.pow(o.x-this.startPos.x,2)+Math.pow(o.y-this.startPos.y,2));i.radius(n);break}case"line":{this.currentShape.points([this.startPos.x,this.startPos.y,o.x,o.y]);break}}this.layer.batchDraw()}),this.stage.on("mouseup touchend",()=>{this.currentShape&&(this.history.push({node:this.currentShape.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null}),this.stage.on("mouseleave",()=>{this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null}),this.layer.on("mouseover",t=>{const e=t.target;e instanceof d.Node&&!(e instanceof d.Stage)&&!(e instanceof d.Layer)&&(e.draggable()&&(document.body.style.cursor="move"),e.getAttr("isScaling")&&(document.body.style.cursor="ew-resize"))}),this.layer.on("mouseout",()=>{document.body.style.cursor="default"}),this.stage.on("wheel",t=>{t.evt.preventDefault();const e=this.stage.scaleX(),a=this.stage.getPointerPosition(),r={x:(a.x-this.stage.x())/e,y:(a.y-this.stage.y())/e},o=t.evt.deltaY>0?-1:1,i=1.1,n=o>0?e*i:e/i;if(n<.1||n>10)return;this.stage.scale({x:n,y:n});const l={x:a.x-r.x*n,y:a.y-r.y*n};this.stage.position(l),this.stage.batchDraw();const c=document.getElementById("zoom-slider"),g=document.getElementById("zoom-level");if(c&&g){const y=Math.round(n*100);c.value=y.toString(),g.textContent=`${y}%`}})}setMode(t){this.mode=t}undo(){if(this.history.length>0){const t=this.history[this.history.length-1];switch(t.type){case"delete":this.layer.add(t.node.clone());break;case"dragToggle":const e=this.layer.findOne(r=>r.id()===t.node.id());e&&e.draggable(!e.draggable());break;default:const a=this.layer.children[this.layer.children.length-1];a&&a.destroy();break}this.history.pop(),this.layer.batchDraw()}}async loadImage(t){return new Promise((e,a)=>{const r=new FileReader;r.onload=()=>{const o=new Image;o.onload=()=>{const i=o.width,n=o.height,l=(this.stage.width()-i)/2,c=(this.stage.height()-n)/2,g=new d.Image({x:l,y:c,image:o,width:i,height:n,draggable:!0,cursor:"move"});this.layer.add(g),this.history.push({node:g.clone()}),this.history.length>this.MAX_HISTORY&&this.history.shift(),this.layer.batchDraw(),e()},o.onerror=a,o.src=r.result},r.onerror=a,r.readAsDataURL(t)})}saveToImage(){const t=this.layer.children;if(t.length===0)return;const e=this.stage.width(),a=this.stage.height(),r=this.stage.scale(),o=this.stage.position();this.stage.scale({x:1,y:1}),this.stage.batchDraw();let i=1/0,n=1/0,l=-1/0,c=-1/0;t.forEach(u=>{const p=u.getClientRect();i=Math.min(i,p.x),n=Math.min(n,p.y),l=Math.max(l,p.x+p.width),c=Math.max(c,p.y+p.height)});const g=100;i-=g,n-=g,l+=g,c+=g;const y=Math.ceil(l-i),w=Math.ceil(c-n),E=t.map(u=>({node:u,x:u.x(),y:u.y()}));t.forEach(u=>{u.x(u.x()-i),u.y(u.y()-n)}),this.stage.width(y),this.stage.height(w);const h=new d.Rect({x:0,y:0,width:y,height:w,fill:"white"});return this.layer.add(h),h.moveToBottom(),this.layer.batchDraw(),new Promise(u=>{setTimeout(()=>{this.layer.batchDraw();const p=this.stage.toDataURL({pixelRatio:1,quality:1,mimeType:"image/png"});E.forEach(({node:S,x:k,y:X})=>{S.x(k),S.y(X)}),this.stage.width(e),this.stage.height(a),this.stage.scale(r),this.stage.position(o),h.destroy(),this.layer.batchDraw(),u(p)},100)})}}const x=b.getInstance(),N=document.getElementById("menu-btn"),R=document.getElementById("close-toolbar"),I=document.getElementById("toolbar");let M=!1;const H=()=>{M=!0,I?.classList.add("open")},C=()=>{M=!1,I?.classList.remove("open")};N?.addEventListener("click",s=>{s.stopPropagation(),M?C():H()});R?.addEventListener("click",()=>{C()});document.addEventListener("click",s=>{const t=s.target;M&&!I?.contains(t)&&t!==N&&!t.closest(".tool-btn")&&C()});I?.addEventListener("click",s=>{s.stopPropagation()});document.getElementById("rect-btn")?.addEventListener("click",()=>x.setMode("rect"));document.getElementById("circle-btn")?.addEventListener("click",()=>x.setMode("circle"));document.getElementById("line-btn")?.addEventListener("click",()=>x.setMode("line"));document.getElementById("pencil-btn")?.addEventListener("click",()=>x.setMode("pencil"));document.getElementById("text-btn")?.addEventListener("click",()=>x.setMode("text"));document.getElementById("undo-btn")?.addEventListener("click",()=>x.undo());document.getElementById("zoom-in-btn")?.addEventListener("click",()=>{const s=document.getElementById("zoom-slider"),t=parseInt(s.value),e=Math.min(t+10,400);s.value=e.toString(),v(e)});document.getElementById("zoom-out-btn")?.addEventListener("click",()=>{const s=document.getElementById("zoom-slider"),t=parseInt(s.value),e=Math.max(t-10,10);s.value=e.toString(),v(e)});const m=document.getElementById("fullscreen-btn"),L=document.getElementById("watermark"),P=document.querySelector("header");m?.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{if(L?.classList.add("hidden"),P?.classList.remove("hidden"),m){const s=m.querySelector("svg");if(s&&(s.innerHTML=`
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            `),m.textContent){const e=m.lastChild;e&&(e.textContent="Toàn màn hình")}}}):document.documentElement.requestFullscreen().then(()=>{if(L?.classList.remove("hidden"),P?.classList.add("hidden"),m){const s=m.querySelector("svg");if(s&&(s.innerHTML=`
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" />
            `),m.textContent){const e=m.lastChild;e&&(e.textContent="Thoát toàn màn hình")}}})});document.addEventListener("fullscreenchange",()=>{if(!document.fullscreenElement&&(L?.classList.add("hidden"),P?.classList.remove("hidden"),m)){const s=m.querySelector("svg");if(s&&(s.innerHTML=`
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
          `),m.textContent){const e=m.lastChild;e&&(e.textContent="Toàn màn hình")}}});const f=document.getElementById("zoom-slider"),z=document.getElementById("zoom-level"),v=s=>{const t=x.getStage();if(!t)return;const e=s/100,a=t.scaleX(),r={x:t.width()/2,y:t.height()/2},o={x:(r.x-t.x())/a,y:(r.y-t.y())/a};t.scale({x:e,y:e});const i={x:r.x-o.x*e,y:r.y-o.y*e};t.position(i),t.batchDraw(),z&&(z.textContent=`${Math.round(s)}%`)};f?.addEventListener("input",s=>{const t=parseInt(s.target.value);v(t)});document.getElementById("zoom-in-control")?.addEventListener("click",()=>{const s=parseInt(f.value),t=Math.min(s+10,400);f.value=t.toString(),v(t)});document.getElementById("zoom-out-control")?.addEventListener("click",()=>{const s=parseInt(f.value),t=Math.max(s-10,10);f.value=t.toString(),v(t)});document.getElementById("zoom-reset")?.addEventListener("click",()=>{f.value="100",v(100)});document.getElementById("zoom-fit")?.addEventListener("click",()=>{f.value="100",v(100)});const B=document.getElementById("image-input");document.getElementById("import-image-btn")?.addEventListener("click",()=>{B?.click()});B?.addEventListener("change",async s=>{const t=s.target.files;if(t){for(const e of Array.from(t))if(e.type.startsWith("image/"))try{await x.loadImage(e)}catch(a){console.error("Error loading image file:",a)}B.value=""}});const T=async()=>{try{const s=await navigator.clipboard.read();for(const t of s)for(const e of t.types)if(e.startsWith("image/")){const a=await t.getType(e),r=new File([a],"pasted-image.png",{type:e});await x.loadImage(r)}}catch(s){console.error("Error reading clipboard:",s)}};document.getElementById("paste-btn")?.addEventListener("click",T);document.addEventListener("paste",T);document.getElementById("save-btn")?.addEventListener("click",async()=>{const s=await x.saveToImage();if(s){const t=document.createElement("a"),e=new Date,a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0")+"-"+String(e.getHours()).padStart(2,"0")+"h"+String(e.getMinutes()).padStart(2,"0")+"s"+String(e.getSeconds()).padStart(2,"0");t.download=`tinh-menh-do-${a}.png`,t.href=s,document.body.appendChild(t),t.click(),document.body.removeChild(t)}});const D=document.querySelectorAll(".tool-btn");D.forEach(s=>{s.addEventListener("click",()=>{D.forEach(t=>t.classList.remove("active")),s.classList.add("active")})});const V=new URLSearchParams(window.location.search);V.get("export")==="1"&&setTimeout(()=>{T()},1e3);
