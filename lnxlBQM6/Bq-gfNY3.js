import{K as h}from"./CNuNv4A4.js";import"./BScVxmeO.js";import"./Cpj98o6Y.js";class c{static instance=null;stage;layer;currentShape=null;isDrawing=!1;mode="rect";startPos={x:0,y:0};isProcessingImage=!1;lastProcessedImage=null;isPanning=!1;lastCenter=null;history=[];MAX_HISTORY=50;constructor(){document.getElementById("drawing-container"),this.stage=new h.Stage({container:"drawing-container",width:window.innerWidth,height:window.innerHeight}),this.layer=new h.Layer,this.stage.add(this.layer),window.addEventListener("resize",()=>{this.stage.width(window.innerWidth),this.stage.height(window.innerHeight)}),this.initializeEvents(),this.initializeToolbar()}static getInstance(){return c.instance||(c.instance=new c),c.instance}initializeEvents(){this.stage.on("contextmenu",e=>{e.evt.preventDefault()}),this.stage.on("mousedown touchstart",e=>{if(e.evt.button===2){this.isPanning=!0,this.lastCenter=this.stage.getPointerPosition(),document.body.style.cursor="grabbing";return}this.isDrawing=!0;const t=this.stage.getPointerPosition();switch(this.startPos=t,this.mode){case"rect":this.currentShape=new h.Rect({x:t.x,y:t.y,width:0,height:0,stroke:"black",strokeWidth:2});break;case"circle":this.currentShape=new h.Circle({x:t.x,y:t.y,radius:0,stroke:"black",strokeWidth:2});break;case"line":this.currentShape=new h.Line({points:[t.x,t.y,t.x,t.y],stroke:"black",strokeWidth:2});break}this.currentShape&&this.layer.add(this.currentShape)}),this.stage.on("mousemove touchmove",e=>{if(this.isPanning&&this.lastCenter){e.evt.preventDefault();const n=this.stage.getPointerPosition(),a=n.x-this.lastCenter.x,s=n.y-this.lastCenter.y;this.stage.position({x:this.stage.x()+a,y:this.stage.y()+s}),this.stage.batchDraw(),this.lastCenter=n;return}if(!this.isDrawing)return;const t=this.stage.getPointerPosition();switch(this.mode){case"rect":const n=this.currentShape,a=t.x-this.startPos.x,s=t.y-this.startPos.y;n.width(a),n.height(s);break;case"circle":const i=this.currentShape,o=Math.sqrt(Math.pow(t.x-this.startPos.x,2)+Math.pow(t.y-this.startPos.y,2));i.radius(o);break;case"line":this.currentShape.points([this.startPos.x,this.startPos.y,t.x,t.y]);break}this.layer.batchDraw()}),this.stage.on("mouseup touchend",()=>{this.currentShape&&(this.history.push(this.currentShape.clone()),this.history.length>this.MAX_HISTORY&&this.history.shift()),this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null}),this.stage.on("mouseleave",()=>{this.isPanning&&(this.isPanning=!1,this.lastCenter=null,document.body.style.cursor="default"),this.isDrawing=!1,this.currentShape=null})}initializeToolbar(){document.getElementById("rect-btn")?.addEventListener("click",()=>this.mode="rect"),document.getElementById("circle-btn")?.addEventListener("click",()=>this.mode="circle"),document.getElementById("line-btn")?.addEventListener("click",()=>this.mode="line"),document.getElementById("zoom-in-btn")?.addEventListener("click",()=>{const s=this.stage.scaleX()*1.2;this.stage.scale({x:s,y:s}),this.layer.batchDraw()}),document.getElementById("zoom-out-btn")?.addEventListener("click",()=>{const s=this.stage.scaleX()/1.2;this.stage.scale({x:s,y:s}),this.layer.batchDraw()});const e=document.getElementById("image-input");let t=!1;const n=async s=>{if(!(t||!s.type.startsWith("image/")))try{t=!0,await this.loadImage(s)}finally{t=!1,e&&(e.value="")}};document.getElementById("import-image-btn")?.addEventListener("click",()=>{e?.click()}),e?.addEventListener("change",s=>{const i=s.target.files?.[0];i&&n(i)});const a=document.getElementById("drawing-container");a.addEventListener("dragover",s=>{s.preventDefault()}),a.addEventListener("drop",s=>{s.preventDefault();const i=s.dataTransfer?.files[0];i&&n(i)}),document.getElementById("undo-btn")?.addEventListener("click",()=>{this.undo()})}loadImage(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>{new Promise(i=>{const o=new Image;o.onload=()=>i(o),o.src=a.result}).then(i=>{const o=new h.Image({x:this.stage.width()/2-i.width/2,y:this.stage.height()/2-i.height/2,image:i,draggable:!0});this.layer.find("Image").forEach(g=>g.destroy()),this.layer.add(o),this.history.push(o.clone()),this.history.length>this.MAX_HISTORY&&this.history.shift(),this.layer.batchDraw(),t()})},a.onerror=n,a.readAsDataURL(e)})}undo(){if(this.history.length>0){const e=this.layer.children[this.layer.children.length-1];e&&(e.destroy(),this.history.pop(),this.layer.batchDraw())}}}const m=document.getElementById("menu-btn"),l=document.getElementById("toolbar");let d=!1;m?.addEventListener("click",r=>{r.stopPropagation(),d=!d,l&&l.classList.toggle("hidden")});document.addEventListener("click",r=>{const e=r.target;d&&!l?.contains(e)&&e!==m&&!e.closest(".tool-btn")&&(d=!1,l?.classList.add("hidden"))});l?.addEventListener("click",r=>{r.stopPropagation()});const u=document.querySelectorAll(".tool-btn");u.forEach(r=>{r.addEventListener("click",()=>{u.forEach(e=>e.classList.remove("active")),r.classList.add("active")})});c.getInstance();
